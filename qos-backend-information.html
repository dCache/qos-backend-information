<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="../util-precondition/precondition-element.html">
<link rel="import" href="../util-majax-requests/majax-requests-element.html">

<!--
`qos-backend-information`

@demo demo/index.html
-->

<script>
    'use strict';
    let QosBackendInformation = Polymer({
        is: 'qos-backend-information',
        hostAttributes: {
            hidden: true
        },
        properties: {
            urls: {
                type: Array,
                notify: true
            },
            auth: {
                type: String,
                notify: true
            },

            /**
             * value: file or directory
             * default to file
             */
            fileType: {
                type: Array,
                value: 'file',
                notify: true
            },

            headers: {
                type: Object,
                notify: true
            }
        },

        factoryImpl: function(apiEndPoint, auth, headers)
        {
            this.auth = auth===undefined? 'Basic bm9ib2R5Om5vcGFzc3dvcmQ=':auth;
            this.headers = headers===undefined? 
                {
                    "Content-type":"application/json", 
                    "Accept": "application/json", 
                    "Suppress-WWW-Authenticate": "Suppress", 
                    "Authorization": this.auth
                }: headers
            this._requestQosPossibilities(apiEndPoint);
        },

        getSiteBackendCapabilities: function()
        {
            try {
                precondition.checkArgument(this.urls != undefined || this.urls != null,
                    'Property \'urls\' cannot be unspecified.');
                precondition.checkArgument(this.urls.length != 0,
                    'Cannot set property \'urls\' to empty array.');
                let requestQosInfo = new MultipleAjaxRequests(this.urls, this.auth, this, this.headers);
                this.addEventListener('allResolved', e => {
                    /**
                     * @event {qos-backend-response}
                     */
                    this.fire('qos-backend-response', {response: e.detail});
                });
                requestQosInfo.send();
            } catch (e) {
                throw new Error(e.message);
            }
        },

        _requestQosPossibilities: function(apiEndPoint)
        {
            const url = apiEndPoint + "qos-management/qos/"+this.fileType;
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.onload = ()=> {
                if (xhr.status >= 200 || xhr.status < 500) {
                    this.urls = [];
                    const x = JSON.parse(xhr.responseText);
                    const response = x.name;
                    for (let i = 0; i < response.length ; i++) {
                        this.urls.push(apiEndPoint + "qos-management/qos/"+this.fileType+"/" + response[i]);
                    }
                    this.getSiteBackendCapabilities();
                } else {
                    new Error("Server Side Error");
                }
            };
            xhr.onerror = function() {
                new Error("Network Error");
            };

            let header;
            for (header in this.headers) {
                xhr.setRequestHeader(header, this.headers[header]);
            }

            xhr.send();
        },
    });
</script>